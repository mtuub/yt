name: Create youtube video
env:
  API_URL: ${{secrets.API_URL}}

on:
  push:
    branches: master

jobs:
  scrape-horoscopes:
    name: Scrape Horsocope
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@main
      - run: npm run install-build
      - run: node build/server/scrape_horoscopes.js
      - uses: actions/upload-artifact@v3
        with:
          name: output
          path: ./output
          retention-days: 1

  generate-tts:
    runs-on: ubuntu-latest
    needs: scrape-horoscopes
    steps:
      - uses: actions/checkout@v2
      - uses: actions/download-artifact@v3
      - run: npm run install-build
      - run: node build/server/generate_tts.js
      - uses: actions/upload-artifact@v3
        with:
          name: output
          path: ./output
          retention-days: 1

  generate-subtitles-and-get-videos-urls:
    runs-on: ubuntu-latest
    needs: generate-tts
    strategy:
      matrix:
        sign: ["aries"]
    steps:
      - uses: actions/checkout@v2
      - uses: actions/download-artifact@v3
      - run: npm run install-build
      - run: node build/server/generate_subtitles_videos.js ${{ matrix.sign }}
      - uses: actions/upload-artifact@v3
        with:
          name: output
          path: ./output
          retention-days: 1

  render-videos:
    runs-on: ubuntu-latest
    needs: generate-subtitles-and-get-videos-urls
    strategy:
      matrix:
        sign: ["aries"]
    steps:
      - uses: actions/checkout@v2
      - uses: actions/download-artifact@v3
      # - uses: dawidd6/action-download-artifact@v2
      #   with:
      #     run_id: 4042410763
      - run: npm install remotion react react-dom @remotion/cli
      - run: mkdir output/videos
      - run: npx remotion render remotion/src/index.tsx  Horoscope output/videos/${{matrix.sign}}.mp4 --props="{\"sign\":\"${{matrix.sign}}\"}"
      - uses: actions/upload-artifact@v3
        with:
          name: output
          path: ./output
          retention-days: 1

  upload-yt:
    runs-on: ubuntu-latest
    needs: render-videos
    steps:
      - uses: actions/checkout@v2
      - uses: actions/download-artifact@v3
      - run: npm run install-build
      - run: node build/server/generate_thumbnails.js
      - run: node build/server/generate_tags.js
      # uplooad yt
      - uses: actions/upload-artifact@v3
        with:
          name: output
          path: ./output
          retention-days: 1
